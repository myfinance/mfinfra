version: '3.4'
services:
  postgres_sonar:
    image: postgres:{{sonar.db_version}}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.role == manager]
    environment:
      POSTGRES_PASSWORD: {{sonar.password}}
      POSTGRES_USER: {{sonar.user}}
    volumes:
     - "sonardbdata:/var/lib/postgresql/data"
    networks:
      - sonarnet     
  sonar:
    image: sonarqube:{{sonar.version}}
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.role == manager]
    ports:
     - '{{sonar.port}}:9000'
     - '9092:9092'
    environment:
      SONARQUBE_JDBC_USERNAME: {{sonar.user}}
      SONARQUBE_JDBC_PASSWORD: {{sonar.password}}
      SONARQUBE_JDBC_URL: jdbc:postgresql://postgres_sonar:5432/sonar
    volumes:
     - "sonar_conf:/opt/sonarqube/conf"
     - "sonar_data:/opt/sonarqube/data"
     - "sonar_extensions:/opt/sonarqube/extensions"
     - "sonar_plugins:/opt/sonarqube/lib/bundled-plugins"
    networks:
      - sonarnet   
networks:
  sonarnet:
volumes:
  sonardbdata: 
  sonar_conf:
  sonar_data:
  sonar_extensions:
  sonar_plugins:
